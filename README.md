# یونی‌شدول

«یونی‌شدول» یک مونو‌لیث جنگویی است که با ترکیب Django 5 و Django REST Framework چرخهٔ کامل برنامه‌ریزی آموزشی را از مدیریت مؤسسات تا انتشار برنامهٔ نهایی روی مانیتورهای اطلاع‌رسانی پوشش می‌دهد. این سند تلاش می‌کند تصویری جامع از پروژه ارائه کند تا توسعه‌دهندگان تازه‌وارد سریع‌تر با معماری، دامنهٔ مسئله و نحوهٔ مشارکت آشنا شوند.

## معرفی سریع

- **چند-سازمانی (Multi-tenant):** هر کاربر به یک مؤسسه متصل است و دسترسی به داده‌ها بر همین اساس کنترل می‌شود. مدل کاربر سفارشی `accounts.User` روی Django `AbstractUser` ساخته شده است تا وابستگی به مؤسسه در سطح پایگاه داده اعمال شود.
- **مدل دادهٔ یکپارچه:** همهٔ مدل‌های دامنه (درس، استاد، کلاس، ترم، نمایشگر و غیره) از `BaseModel` ارث می‌برند تا حذف نرم و زمان‌مهر استاندارد داشته باشند و کوئری‌های روزمره فقط رکوردهای فعال را ببینند.
- **پاسخ‌های پایدار:** هستهٔ `unischedule.core` مجموعه‌ای از کدهای موفق/خطا و کلاس پاسخ مشترک `BaseResponse` را در اختیار می‌گذارد تا تمام APIها خروجی هم‌شکل با متادیتای صفحه‌بندی تولید کنند.
- **پروسهٔ زمان‌بندی:** سرویس‌های اپ `schedules` از رخداد تداخل زمانی میان استاد، کلاس و بازهٔ زمانی جلوگیری می‌کنند و پس از هر تغییر، کش نمایشگرهای مرتبط را بی‌درنگ پاک می‌کنند تا دادهٔ به‌روز روی مانیتورها نمایش داده شود.
- **مانیتورینگ برنامه‌ها:** اپ `displays` اجازه می‌دهد برای هر مانیتور مجموعه‌ای از فیلترهای پویا تعریف شود (روز، نوع هفته، ساختمان، گروه و ...). خروجی نهایی با caching سطح slug منتشر می‌شود و شامل اطلاعات مؤسسه و کلاس‌ها به‌صورت مرتب‌شده است.
- **ابزارهای جانبی:** اسکریپت کمکی `scripts/clean_postman_fragments.py` خروجی Postman را از تگ‌های ناخواستهٔ StartFragment/EndFragment پاک می‌کند تا داکیومنت API تمیز بماند.

## معماری در یک نگاه

پروژه از الگوی «ویو نازک، سرویس پرمایه» پیروی می‌کند: ویوها صرفاً دادهٔ خام را از درخواست می‌گیرند و به سرویس‌ها پاس می‌دهند. سرویس‌ها نیز برای دسترسی به پایگاه داده از لایهٔ مخزن (Repository) استفاده می‌کنند. این جداسازی باعث می‌شود منطق دامنهٔ هر اپ قابل‌تست و قابل‌استفادهٔ مجدد باشد.

```
unischedule/
├── accounts/          # کاربران سفارشی، ورود و مدیریت پروفایل مؤسسه
├── institutions/      # موجودیت مؤسسه و لوگو/مشخصات تکمیلی
├── semesters/         # ترم‌های فعال و تنظیم ترم جاری
├── professors/        # مشخصات استادان و جست‌وجوی آن‌ها
├── courses/           # دروس، ارتباط با استاد/کد ارائه و واحدها
├── locations/         # ساختمان‌ها و کلاس‌ها با ظرفیت
├── schedules/         # جلسات کلاس، جلوگیری از تداخل و حذف نرم
├── displays/          # پیکربندی مانیتورها، کش و خروجی عمومی
├── unischedule/core/  # مدل پایه، پاسخ‌های مشترک، کد خطا/موفقیت
├── scripts/           # ابزارهای خط فرمان کمکی (Postman cleaner)
└── Unischedule API.postman_collection.json
```

### لایهٔ هسته (Core)

- `BaseModel` و `ActiveManager` رفتار حذف نرم را در تمام مدل‌ها پیاده می‌کنند تا حذف داده‌ها قابل بازگشت باشد.
- `BaseResponse` قالب پاسخ موفق/ناموفق و ابزار صفحه‌بندی را فراهم می‌کند تا تمام ویوها JSON همسان تولید کنند.
- `ErrorCodes` و `SuccessCodes` دیکشنری‌های استانداردی تعریف می‌کنند که سرویس‌ها می‌توانند مستقیماً در خطاها از آن استفاده کنند تا پیام انسانی و کد منطقی هماهنگ باقی بماند.

### لایهٔ دامنه

| اپلیکیشن | نقش | نکات برجسته |
| --- | --- | --- |
| `accounts` | احراز هویت و پروفایل مؤسسه | احراز هویت توکنی DRF، نقطهٔ مدیریت لوگوی مؤسسه، mixin‌های اطمینان از اتصال کاربر به مؤسسه |
| `institutions` | مشخصات مؤسسات آموزشی | CRUD کامل با سریالایزرهای تفکیک‌شده برای ورودی/خروجی و اعتبارسنجی یکتایی نامک |
| `semesters` | مدیریت ترم‌های درسی | جلوگیری از فعال‌سازی همزمان چند ترم و نگهداری تاریخ شروع/پایان برای فیلترهای نمایشگر |
| `professors` و `courses` | دیکشنری استاد و درس | اتصال درس به استاد اصلی و اطلاعات واحد/کد ارائه، پشتیبانی از جست‌وجو و فیلتر در API |
| `locations` | ساختمان و کلاس | نگهداری ظرفیت کلاس و ارتباط با ساختمان برای استفاده در فیلترهای نمایشگر |
| `schedules` | جلسات کلاس | جلوگیری از تداخل زمانی (استاد یا کلاس)، حذف نرم، و همگام‌سازی کش نمایشگرها پس از هر تغییر |
| `displays` | مانیتورهای اطلاع‌رسانی | فیلترهای پویا بر اساس روز/نوع هفته/ساختمان/گروه، محاسبهٔ اتوماتیک فیلتر روز/هفته و خروجی JSON مرتب برای مصرف عمومی |

## جریان‌های کلیدی

1. **ورود و اتصال به مؤسسه:** کاربر پس از دریافت توکن از `/api/accounts/login/`، از طریق هدر `Authorization: Token <token>` با API تعامل می‌کند. همهٔ سرویس‌ها قبل از عملیات، وجود مؤسسه را بررسی می‌کنند تا دسترسی خارج از محدوده رخ ندهد.
2. **مدیریت دادهٔ پایه:** مدیر مؤسسه با استفاده از اپ‌های دامنه (درس، استاد، ساختمان، کلاس، ترم) اطلاعات پایه را ثبت می‌کند. همهٔ عملیات با حذف نرم محافظت شده‌اند تا تاریخچهٔ داده در دسترس باشد.
3. **برنامه‌ریزی جلسات:** هنگام ثبت یا ویرایش جلسه، سرویس `class_session_service` با کمک مخزن داده بررسی می‌کند که بازهٔ زمانی در همان ترم، کلاس یا استاد تداخل نداشته باشد؛ در صورت تشخیص، خطایی با کد استاندارد بازگردانده می‌شود.
4. **انتشار روی نمایشگرها:** هر نمایشگر می‌تواند فیلترهای متفاوتی داشته باشد (مثلاً فقط کلاس‌های ساختمان A در هفتهٔ زوج). سرویس `display_service` ابتدا محتوای مناسب را انتخاب و مرتب می‌کند و سپس نتیجه را در کش با کلید `display:<slug>` قرار می‌دهد. تغییر هر جلسه یا ویرایش نمایشگر کش مربوطه را پاک می‌کند تا دادهٔ تازه ارائه شود.

## تکنولوژی‌ها و وابستگی‌ها

- **زبان و فریم‌ورک:** Python 3.12، Django 5، Django REST Framework
- **احراز هویت:** `rest_framework.authtoken`
- **پایگاه دادهٔ پیش‌فرض:** SQLite (قابل تعویض از طریق `unischedule/settings.py`)
- **کش:** backend پیش‌فرض Django؛ می‌توان برای محیط عملیاتی به Redis یا Memcached مهاجرت کرد.
- **اسکریپت‌ها:** ابزار خط فرمان برای پاکسازی توضیحات Postman و آماده‌سازی کالکشن.

## راه‌اندازی در محیط توسعه

```bash
python -m venv .venv
source .venv/bin/activate          # در ویندوز: .venv\Scripts\activate
pip install -r requirements.txt
python manage.py migrate
python manage.py createsuperuser   # برای ورود به پنل مدیریت
python manage.py runserver
```

نکات پیکربندی:

- `DEBUG` در محیط توسعه فعال است؛ برای استقرار حتماً آن را غیرفعال و کلید مخفی را از متغیر محیطی دریافت کنید.
- منطقهٔ زمانی پیش‌فرض `Asia/Tehran` است. در صورت نیاز می‌توانید `TIME_ZONE` و `USE_TZ` را در تنظیمات تغییر دهید.
- فایل کالکشن Postman همراه پروژه قرار دارد؛ با import آن می‌توانید همهٔ endpointها را تست کنید.

## تست و تضمین کیفیت

پوشش تست به‌صورت ترکیبی از تست‌های واحد و انتها-به-انتها انجام می‌شود. برای اجرای کامل تست‌ها:

```bash
python manage.py test
```

نمونهٔ تست‌های کلیدی:

- جلوگیری از تداخل برنامه‌ریزی جلسه‌ها و صحت حذف نرم در مدل `ClassSession`.
- اطمینان از اینکه کاربران بدون مؤسسه نمی‌توانند به سرویس‌ها دسترسی داشته باشند و پیام خطای استاندارد دریافت می‌کنند.

## مستندات و ابزارهای API

- فایل [Unischedule API.postman_collection.json](Unischedule%20API.postman_collection.json) حاوی درخواست‌های آماده برای تمام سناریوهای CRUD و خروجی عمومی نمایشگرها است.
- ساختار پایهٔ پاسخ‌ها در همهٔ endpointها مشابه نمونهٔ زیر است:

```json
{
  "success": true,
  "code": "1000",
  "message": "عملیات موفقیت‌آمیز بود.",
  "data": {"...": "..."},
  "warnings": [],
  "meta": {}
}
```

- برای پاکسازی تگ‌های StartFragment/EndFragment پس از export از Postman می‌توانید دستور زیر را اجرا کنید:

```bash
python scripts/clean_postman_fragments.py "Unischedule API.postman_collection.json"
```

### لغو جلسه و کلاس‌های جبرانی
مجموعهٔ جدید «Class Adjustments» در کالکشن Postman تمام عملیات مرتبط با لغو جلسه و ثبت کلاس‌های جبرانی را پوشش می‌دهد:
- `GET /api/schedules/cancellations/`، `POST /api/schedules/cancellations/create/` و سایر متدهای هم‌خانواده برای مدیریت لغوها با کدهای موفقیت `2606` تا `2610`.
- `GET /api/schedules/makeups/`، `POST /api/schedules/makeups/create/` و متدهای تکمیلی برای جبرانی‌ها با کدهای موفقیت `2611` تا `2615`.
توضیحات هر درخواست شامل نمونهٔ ورودی/خروجی، سناریوهای خطا (کدهای خطای `4605`، `4606`، `4610`، `4611` و ...) و الزامات احراز هویت است تا تیم پشتیبانی بتواند سریعاً فرایند لغو و جبرانی را مدیریت کند.

## پیشنهادهای توسعهٔ آینده

- افزودن داشبورد مدیریتی برای مشاهدهٔ وضعیت نمایشگرها، آخرین به‌روزرسانی کش و پیام‌های خطا.
- پیاده‌سازی موتور زمان‌بندی خودکار بر اساس ظرفیت کلاس‌ها، محدودیت استادان و الگوهای هفته.
- توسعهٔ لایهٔ گزارش‌گیری (به‌عنوان مثال، تعداد ساعات تدریس هر استاد در بازهٔ زمانی مشخص یا استفاده از کلاس‌ها بر اساس ساختمان).

## مشارکت

Pull Requestها خوش‌آمد می‌گویند! پیش از ارسال:

1. تست‌ها را اجرا کنید.
2. پیام Commit و PR را با توضیح شفاف تغییرات بنویسید.
3. در صورت افزودن ویژگی جدید، بخش مرتبط در این README یا کالکشن Postman را به‌روزرسانی کنید.

با دنبال کردن این راهنما می‌توانید در کوتاه‌ترین زمان در توسعهٔ «یونی‌شدول» مشارکت کنید.
