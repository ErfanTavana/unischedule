# یونی‌شدول

سامانهٔ «یونی‌شدول» یک مونو‌لیث جنگویی است که با تکیه بر Django 5 و Django REST Framework تمام چرخهٔ برنامه‌ریزی آموزشی را پوشش می‌دهد؛ از مدیریت نهاد آموزشی، درس و استاد گرفته تا زمان‌بندی جلسات و انتشار برنامهٔ نهایی روی مانیتورهای اطلاع‌رسانی. این مستند راهنمایی است برای توسعه‌دهندگانی که می‌خواهند پروژه را راه‌اندازی کنند یا در توسعهٔ آن مشارکت داشته باشند.

## امکانات کلیدی
- **لایهٔ هویت و دسترسی:** کاربران سفارشی (`accounts.User`) با احراز هویت توکنی DRF و اتصال هر کاربر به یک مؤسسهٔ آموزشی.
- **مدیریت پایهٔ داده‌ها:** اپ‌های دامنه‌محور برای مؤسسات، ترم‌ها، اساتید، دروس، ساختمان‌ها و کلاس‌ها که همگی از `BaseModel` با حذف نرم و زمان‌مهر مشترک بهره می‌برند.
- **برنامه‌ریزی کلاس‌ها:** اپ `schedules` سرویس‌های ایجاد، ویرایش، حذف نرم و جلوگیری از تداخل زمانی جلسات را فراهم می‌کند و خروجی استاندارد `BaseResponse` برمی‌گرداند.
- **نمایشگرهای عمومی:** اپ `displays` به مدیر امکان می‌دهد برای هر مانیتور یک فیلتر واحد (مثلاً ساختمان، کلاس، استاد، نوع هفته یا روز خاص) تعریف کند، مقدار روز و نوع هفته را به‌شکل خودکار از تاریخ جاری یا تاریخ جایگزین محاسبه کند و خروجی JSON قابل مصرف برای تلویزیون‌ها یا اپ‌های فرانت‌اند تولید کند.
- **پاسخ‌های یکدست:** تمام APIها از هستهٔ مشترک (کلاس‌های پاسخ موفق/خطا، کدهای پیام و استثناءهای سفارشی) استفاده می‌کنند تا پیام‌های کاربرپسند و قابل لاگ تولید شود.

## معماری و ساختار پوشه‌ها
پروژه از الگوی لایه‌ای پیروی می‌کند؛ هر اپ به‌صورت مستقل شامل مدل، مخزن، سرویس، سریالایزر و ویو است و ویو صرفاً سرویس متناظر را فراخوانی می‌کند.

```
unischedule/
├── accounts/              # احراز هویت و کاربران سفارشی
├── courses/               # مدیریت درس و استاد درس
├── displays/              # پیکربندی نمایشگرها و خروجی عمومی
├── institutions/          # نهاد/مؤسسه آموزشی
├── locations/             # ساختمان‌ها و کلاس‌ها
├── professors/            # اطلاعات استادان
├── schedules/             # جلسات کلاس و کنترل تداخل
├── semesters/             # ترم‌های آموزشی
├── unischedule/           # تنظیمات و URLهای پروژه
└── "Unischedule API.postman_collection.json"
```

## راه‌اندازی سریع
```bash
python -m venv .venv
source .venv/bin/activate          # در ویندوز: .venv\Scripts\activate
pip install -r requirements.txt
python manage.py migrate
python manage.py createsuperuser   # اختیاری ولی توصیه می‌شود
python manage.py runserver
```

نکات تکمیلی:
- پایگاه دادهٔ پیش‌فرض SQLite است؛ برای استفاده از پایگاه‌های دیگر کافی است تنظیمات `DATABASES` را در `unischedule/settings.py` تغییر دهید.
- منطقهٔ زمانی پیش‌فرض پروژه `Asia/Tehran` است؛ در صورت نیاز به منطقهٔ زمانی دیگر، مقدار `TIME_ZONE` را در `unischedule/settings.py` یا متغیر محیطی متناظر به‌روزرسانی کنید.
- با توجه به فعال بودن `TokenAuthentication`، پس از ورود کاربر باید از توکن بازگشتی در هدر `Authorization: Token <token>` استفاده کنید.
- مقدار `DEBUG` در حالت توسعه فعال است؛ پیش از استقرار در محیط عملیاتی آن را غیرفعال کرده و کلید مخفی را از متغیر محیطی بخوانید.

## اجرای تست‌ها
```bash
python manage.py test
```
تست‌ها سناریوهای کلیدی هر اپ (از جمله جلوگیری از تداخل برنامهٔ کلاس‌ها و احراز هویت) را پوشش می‌دهند. پیشنهاد می‌شود پیش از هر انتشار، تست‌ها اجرا شوند.

## مستندات API
- همهٔ درخواست‌های آماده در فایل [Unischedule API.postman_collection.json](Unischedule%20API.postman_collection.json) قرار دارد؛ با وارد کردن این کالکشن در Postman می‌توانید تمام سناریوهای CRUD و لینک عمومی نمایشگرها را اجرا کنید.
- الگوی پاسخ‌ها مبتنی بر `BaseResponse` است و ساختار کلی زیر را دارد:

```json
{
  "success": true,
  "code": "2000",
  "message": "پیام موفق",
  "data": {"...": "..."},
  "errors": []
}
```

- برای دریافت توکن می‌توانید به مسیر `/api/accounts/login/` درخواست POST با نام کاربری و رمز عبور بفرستید.

## ماژول نمایشگرها در یک نگاه
- ایجاد نمایشگر: `POST /api/displays/screens/create/`
- به‌روزرسانی: `PUT /api/displays/screens/{id}/update/`
- حذف نرم: `DELETE /api/displays/screens/{id}/delete/`
- خروجی عمومی برای مصرف تلویزیون یا وب‌اپ: `GET /displays/{slug}/`

فیلترهای هر نمایشگر اکنون از فلگ‌های `filter_use_current_day_of_week` و `filter_use_current_week_type` پشتیبانی می‌کنند تا در صورت تمایل، مقدار نهایی روز یا نوع هفته از تاریخ فعلی یا تاریخ سفارشی (`filter_date_override`) استخراج شود. علاوه بر مقادیر ذخیره‌شده، سرویس نمایشگر دو فیلد محاسباتی `filter_computed_day_of_week` و `filter_computed_week_type` را نیز در خروجی بازمی‌گرداند تا کلاینت‌ها بدون منطق اضافی از نتیجه نهایی فیلتر آگاه شوند.

هر نمایشگر یک مجموعه فیلتر فعال دارد که توسط سرویس `display_service` اعمال می‌شود؛ پس از هر تغییر، کش خروجی با کلید `display:<slug>` به‌روزرسانی می‌شود تا دادهٔ تازه به کلاینت برسد.

از نسخهٔ حاضر به بعد می‌توانید مدت مکث بین نمایش صفحات را با فیلد `filter_page_pause_seconds` تعیین کنید. این مقدار اکنون در پایگاه داده ذخیره می‌شود و همچنان با `filter_duration_seconds` همگام می‌ماند تا هم سازگاری گذشته حفظ شود و هم مقدار مکث مستقل برای فرانت‌اند در دسترس باشد.

## مسیر توسعهٔ پیشنهادی
- افزودن لایهٔ گزارش‌گیری برای استخراج گزارش‌های ساعتی/هفتگی بر اساس استاد یا کلاس.
- توسعهٔ داشبورد وضعیت نمایشگرها (آخرین زمان به‌روزرسانی، خطاهای احتمالی، شناسهٔ خطا).
- پیاده‌سازی موتور زمان‌بندی هوشمند برای تولید خودکار برنامه بر اساس ظرفیت کلاس، تقویم ترم و محدودیت‌های استادان.

## مجوز و مشارکت
پروژه به‌صورت آزاد در دسترس است. در صورت ارسال Pull Request، لطفاً قبل از آن تست‌ها را اجرا کنید و توضیح مختصری از تغییرات در پیام Commit و PR بنویسید.
